<html>
    <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="../assets/css/mystyle.css" rel="stylesheet">
    <link href="../assets/css/scrabble.css" rel="stylesheet">
    <title>SCRABBLE</title>
	<style>
        body {
            overflow-y: hidden;
        }
	</style>
	<body>
        <div class="container-fluid">	
            <div id="game_portal" class="row align-center h-100 d-none">
                <div class="menu col-md-6 text-center">
                    <div class="row">
                        <div class="col-md-12 mb-5 text-center">
                            <div class="mb-5 fs-2">CREATE NEW ROOM</div>
                            <span><button id="btn_create" class="strict-interact btn btn-primary">CREATE</button></span>
                        </div> 
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-12 mt-5 text-center">
                            <div class="mb-5 fs-2">JOIN EXISTING ROOM</div>
                            <strong>ENTER ROOM ID</strong>
                            <br/>
                            <input id="room_id" class="strict-interact inp" placeholder="enter room id">
                            <br/><br/>
                            <button id="btn_join" class="strict-interact btn btn-primary">JOIN</button>
                       </div>
                    </div>
                </div>
                
                <div class="col-md-6 h-100 " style="border-left-style: groove;border-left: solid 1px ;border-color:gray;">
                    <h3><strong>ROOM LIST</strong></h3>
                    <div id="room_list" style="max-height:90%; overflow:auto;"></div>
                </div>
            </div>

            <div id="game" class="d-none">
                <div class="modal modal-sheet position-absolute d-block bg-body-transparent p-4 py-md-5 fade d-none" tabindex="-1" role="dialog" id="modalSetLetter">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content rounded-4 shadow">
                            <div class="modal-header p-5 pb-4 border-bottom-0 align-items-center">
                                <h1 class="fw-bold mb-0 fs-2">Select a letter</h1>
                            </div>
                            <div class="modal-body p-5 pt-0">
                                <div class="form-floating mb-2">
                                    <select class="form-select" id="st_letter_inp">
                                        <option>A</option>
                                        <option>B</option>
                                    </select>
                                </div>
                                <div class="modal-footer flex-nowrap p-0">
                                    <button class="w-50 mb-2 btn btn-lg rounded-3 btn-primary" onclick="change_leter()">OK</button>
                                    <button class="w-50 mb-2 btn btn-lg rounded-3 btn-primary" onclick="show_change_leter()">CANCEL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal modal-sheet position-absolute d-block bg-body-transparent p-4 py-md-5 fade d-none" tabindex="-1" role="dialog" id="modalGameResult">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content rounded-4 shadow">
                            <div class="modal-header p-5 pb-4 border-bottom-0 align-items-center">
                                <h1 class="fw-bold mb-0 fs-2">Game Winner</h1>
                            </div>
                            <div class="modal-body p-5 pt-0">
                                <div id="dsp_game_result" class="form-floating mb-2">
                                    
                                </div>
                                <div class="modal-footer flex-nowrap p-0">
                                    <button class="w-100 mb- btn btn-lg rounded-3 btn-primary" onclick="start_game()">PLAY AGAIN</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row bg-primary">
                    <div class="p-2 d-flex justify-content-between">
                        <div class="col text-white fs-5 fw-bold">
                            SCRABBLE
                        </div>
                        <div id="room_controls">
                            <span class="badge d-flex fs-6 align-items-center text-bg-primary rounded-pill">
                                <strong>ROOM ID:</strong>&ensp;<span id="room_id_dsp" class="" >???</span>
                                <i id="btn_copy" class="btn btn-primary fa-solid fa-copy" onclick="copy_room_id()" title="copy"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row p-2">
                        <div class="col-2">
                            <div id="player1" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p1_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p1_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p1_status"></small>
                                        <!--a id="p1_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p1_indc"></div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div id="player3" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p3_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p3_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p3_status"></small>
                                        <!--a id="p3_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p3_indc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-8 text-center">
                            <div class="row h-80">
                                <div class="col-12 p-3">
                                    <div id="game_board_holder" style="overflow:auto; margin:0px;">
                                        <div id="game_board"></div>
                                    </div>
                                </div>
                            </div>
                            
                            
                        </div>

                        <div class="col-2">
                            <div id="player2" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p2_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p2_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p2_status"></small>
                                        <!--a id="p2_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p2_indc"></div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div id="player4" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p4_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p4_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p4_status"></small>
                                        <!--a id="p4_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p4_indc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div> 

                <div class="row">
                    <div class="col-12">
                        <div id="game_controls" class="fixed-bottom mt-5 w-100">
                            <table class="table table-bordered">
                                <tr>
                                    <td style="width:170px;background-color:black;text-align: center;">
                                        <div class="position-relative"  ondrop='pouch_dropHandler(event)' ondragover='pouch_dragoverHandler(event)' id="pouch">
                                            <img class="button-mode" id="dice_static" src="../images/scrabble/pouch.jpg" width="100px" height="100px">
                                            <br/>
                                            <div id="pouch_bag">100</div>
                                        </div>

                                        <label style="width:100%;color: white;text-align:center;">Tiles Left</label>
                                    </td>
                                    <td id="interact_area" style="width:500px;text-align:center;">
                                        <div id="btn_controls" class="d-flex justify-content-between position-relative">
                                            <button id="btn_submit" class="btn btn-primary mt-2" onclick="check_word_composition()">SUBMIT</button>
                                            <button id="btn_cancel" class="btn btn-danger mt-2" onclick="cancel_compose()">CANCEL</button>
                                        </div>
                                        <div id="player_rack" class="position-relative">&nbsp;</div>
                                        <button id="btn_play" class="btn btn-primary mt-2 position-relative" onclick="start_game()">START</button>
                                        <div id="turn_controls" class="d-flex justify-content-between align-items-center position-relative">
                                            <div>
                                            <a id="btn_draw" class="btn btn-sm btn-outline-secondary d-none" onclick="pouch_player_redraw()">DRAW</a>
                                            </div>
                                            <div>Drag the tiles to pouch to replace from your rack</div>
                                            <div>
                                                <a id="btn_skip" class="btn btn-sm btn-outline-secondary" onclick="skip_turn()">PASS</a>
                                            </div>
                                        </div>
                                    </td>
                                    <td  style="width:170px;background-color:black;text-align: center;">
                                        <label id="game_msg" style="color:white;font-weight:bold;">Waiting for players...</label>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div> 
            </div>

            
        </div>                            
	</body>

	<script src="/socket.io/socket.io.js"></script>
    <script src="../assets/dist/js/jquery-3.6.3.js"></script>
    <script src="../assets/js/scripts.js"></script>
	<script>
        let img_dir = "../images/scrabble/";
        let player_piece = "";
        let room_data = {};
        let player_turn = 0;
        let ind_arr;
        let game_id = "scrabble";
        let room_index = [
            ["title","SCRABBLE"], 
            ["game_id",game_id],
            ["id","room_id"], 
            ["max_players",4],
            ["min_players",2],
            ["t_limit",3600], 
            ["turn","int"],
            ["winner","int"],
            ["status", ""],
            ["board", "array"],
            ["temp", "array"],
            ["pouch_bag", "array"],
            ["result", "string"],
            ["mod","int"],
            ["word_count","int"],
            ["_1","string"],
            ["_2","string"]

        ];
        let player_index = [
            ["pid","player_ind"], 
            ["name",player_name], 
            ["status","active"], 
            ["char","string"],
            ["score","int"],
            ["temp_sco","int"],
            ["rack","array"],
            ["skip","int"]
        ];

        const bonus_cell = {
            'tws':{
                'multi':'3xword',
                'index':['1_1','1_8','1_15','8_1','8_15','15_1','15_8','15_15']
            },
            'dws':{
                'multi':'2xword',
                'index':['8_8','2_2','2_14','3_3','3_13','4_4','4_12','5_5','5_11','11_5','11_11','12_4','12_12','13_3','13_13','14_2','14_14']
            },
            'tls':{
                'multi':'3xletter',
                'index':['2_6','2_10','6_2','6_6','6_10','6_14','10_2','10_6','10_10','10_14','14_6','14_10']
            },
            'dls':{
                'multi':'2xletter',
                'index':['1_4','1_11','3_7','3_9','4_1','4_8','4_15','7_3','7_7','7_9','7_13','8_4','8_12','9_3','9_7','9_9','9_13','12_1','12_8','12_15','13_7','13_9','15_4','15_12']
            }
        }

        //let pouch = ['','_','a1','b3','c3','d2','e1','f4','g2','h4','i1','j8','k5','l1','m3','n1','o1','p3','q10','r1','s1','t1','u1','v4','w4','x8','y4','z10'];
        let sp_cells = [];
        let std_tile_piece = {'_1':1,'_2':1,'a1':9,'b3':2,'c3':2,'d2':4,'e1':12,'f4':2,'g2':3,'h4':2,'i1':9,'j8':1,'k5':1,'l1':4,'m3':2,'n1':6,'o1':8,'p3':2,'q10':1,'r1':6,'s1':4,'t1':6,'u1':4,'v4':2,'w4':2,'x8':1,'y4':2,'z10':1}
        let dimen = {'cell':[],'blk':[]}
        let active_players = []

        let bonus_sets = {};
        let tile_sets_scores = {};
        let tile_sets_letters = {};
        function set_bonus_cells(){
            let i;
            for(i=0; i<bonus_cell['tws']['index'].length; i++){
                bonus_sets[bonus_cell['tws']['index'][i]] = bonus_cell['tws']['multi'];
            }
            for(i=0; i<bonus_cell['tls']['index'].length; i++){
                bonus_sets[bonus_cell['tls']['index'][i]] = bonus_cell['tls']['multi'];
            }
            for(i=0; i<bonus_cell['dws']['index'].length; i++){
                bonus_sets[bonus_cell['dws']['index'][i]] = bonus_cell['dws']['multi'];
            }
            for(i=0; i<bonus_cell['dls']['index'].length; i++){
                bonus_sets[bonus_cell['dls']['index'][i]] = bonus_cell['dls']['multi'];
            }

            let tmp_ind = Object.keys(std_tile_piece);
            let cbox_str = "";
            for(i=0; i<tmp_ind.length; i++){
                tile_sets_scores[tmp_ind[i]] = parseInt(tmp_ind[i].substring(1, tmp_ind[i].length));
                if(tmp_ind[i] == "_1" || tmp_ind[i] == "_2"){
                    tile_sets_scores[tmp_ind[i]] = 0;
                }
                else{
                    tile_sets_letters[tmp_ind[i]] = tmp_ind[i].substring(0, 1);
                    cbox_str += "<option value='"+tile_sets_letters[tmp_ind[i]]+"'>"+(tile_sets_letters[tmp_ind[i]].toUpperCase())+"</option>"
                }
            }

            $("#st_letter_inp").html(cbox_str);
            $("#game_board_holder").css("maxHeight", (window.innerHeight*.68)+"px");
            $("#game_controls").css("maxHeight", "150px");
            $("#player_rack").css('background-image', "url('../images/scrabble/scrabble_rack.png')");
            $("#player_rack").css('background-repeat', "no-repeat");
            $("#player_rack").css('background-size', "470px 60px");
            $("#player_rack").css('background-position', "17 15");
        }
        set_bonus_cells();
        

        function start_game(){
            socket.emit("command", ["", "start", ind_arr[0], get_random_num(active_players.length), "*", ""]);
        }

        function show_message(text_msg){
            $("#game_msg").html(text_msg);
        }
        
        function set_board(){
			let str = "";
            let ctr = 0;

            let tws = [1,8,15,106,120,211,218,225];
            let dws = [17,29,33,43,49,57,65,71,155,161,169,177,183,193,197,209];
            let tls = [21,25,77,81,85,89,137,141,145,149,201,205];
            let dls = [4,11,37,39,46,53,60,93,97,99,103,109,117,123,127,129,133,166,173,180,187,189,214,222];
            let i;
                    
            for(i=0; i<tws.length; i++){
                sp_cells[tws[i]-1] = "tws";
            }

            for(i=0; i<dws.length; i++){
                sp_cells[dws[i]-1] = "dws";
            }

            for(i=0; i<tls.length; i++){
                sp_cells[tls[i]-1] = "tls";
            }

            for(i=0; i<dls.length; i++){
                sp_cells[dls[i]-1] = "dls";
            }

            let ctr_c = 1;
			let ctr_r = 1;

			for(let g=1; g<=15; g++){
                for(let h=1; h<=15; h++){
                    let ind = g+'_'+h;
				    dimen['cell'][ind] = ctr;
				    dimen['blk'][ctr] = ind;

                    str += "<div ondrop='dropHandler(event)' ondragover='dragoverHandler(event)' class='board-cell' cell_addr='"+g+"_"+h+"' id='cell_"+ctr+"' tile_index='"+ctr+"'></div>";
                    ctr++;
                }
			}
            //console.log(dimen);
			
            $("#game_board").html(str);
            set_board_position("8_8");

			for(let j=0; j<225; j++){
                    if(j==112){
                        $("#cell_"+j).css('background-image', "url('"+img_dir+"scrabble_star.png')");
                    }
                    else if(sp_cells[j] != undefined){
                        $("#cell_"+j).css('background-image', "url('"+img_dir+"scrabble_"+sp_cells[j]+".png')");
                    }

                    $("#cell_"+j).css('background-size', '53px 58px');
					$("#cell_"+j).css('background-color', '#FFCC99');
					$("#cell_"+j).css('background-repeat', 'no-repeat');
			}
		}

        function find_composed_words(bench_ind, mod){
            let std_val;
            let std_ind;
            if(mod == 15){
                std_val = ((dimen['blk'][bench_ind]).split("_"))[1];
                std_ind = 1
            }
            else{
                std_val = ((dimen['blk'][bench_ind]).split("_"))[0];
                std_ind = 0
            }

            let w = "";
            let tmp_sco = 0;
            
            while(1){
                //try{
                    
                    if(room_data['board'][bench_ind-mod] != "" && room_data['board'][bench_ind-mod] != undefined && ((dimen['blk'][bench_ind-mod]).split("_"))[std_ind] == std_val)
                        bench_ind -= mod;
                    else
                        break;
                //}catch(e){break;}
            }
            while(1){
                //try{
                    if(room_data['board'][bench_ind] != "" && room_data['board'][bench_ind] != undefined && ((dimen['blk'][bench_ind]).split("_"))[std_ind] == std_val){
                        if(room_data['board'][bench_ind] == "_1" || room_data['board'][bench_ind] == "_2")
                            w += room_data[room_data['board'][bench_ind]];
                        else
                            w += room_data['board'][bench_ind][0];
                        tmp_sco += tile_sets_scores[room_data['board'][bench_ind]];  
                    }
                    else
                        break;

                    bench_ind += mod;
                //}catch(e){break;}
            }
            
            return [w, tmp_sco];
        }

        function check_word_composition(){
            if(room_data['temp'].length != 0){
                sort_array(room_data['temp'], "asc");

                let w_arr = {'hw':[], 'vw':[]};
                let ehw = {}
                let evw = {}
                let tmp_w;
                let tmp_bonus = {}
                let word_bonus = {'h':0, 'v':0};
                let letter_bonus = 0;
                //console.log(room_data['temp'])
                for(let i=0; i<room_data['temp'].length; i++){
                    let bonus_equiv = bonus_sets[dimen['blk'][room_data['temp'][i]]];
                    let bonus_multi = 0;
                    if(bonus_equiv != undefined && (bonus_equiv == "3xletter" || bonus_equiv == "2xletter")){
                        tmp_bonus[room_data['temp'][i]] = bonus_equiv;
                        if(bonus_equiv == "3xletter")
                            letter_bonus = tile_sets_scores[room_data['board'][room_data['temp'][i]]] * 3
                        else if(bonus_equiv == "2xletter")
                            letter_bonus = tile_sets_scores[room_data['board'][room_data['temp'][i]]] * 2
                    }

                    
                    tmp_w = find_composed_words(room_data['temp'][i], 1);
                    //console.log(tmp_w, "<1", bonus_equiv)
                    if(tmp_w[0].length > 1){
                        
                        if(bonus_equiv != undefined && (bonus_equiv == "3xword" || bonus_equiv == "2xword")){
                            tmp_bonus[tmp_w[0]] = bonus_equiv;
                            if(bonus_equiv == "3xword")
                                word_bonus['h'] += tmp_w[1] * 2;
                            else if(bonus_equiv == "2xword")
                                word_bonus['h'] += tmp_w[1] * 1;
                        }
                        
                        if(ehw[tmp_w[0]] == undefined){
                            w_arr['hw'].push(tmp_w[0]);
                            ehw[tmp_w[0]] = 1;
                            room_data[player_turn]['temp_sco'] += tmp_w[1];
                        }
                    }

                    tmp_w = find_composed_words(room_data['temp'][i], 15);
                    //console.log(tmp_w, "<15", bonus_equiv)
                    if(tmp_w[0].length > 1){
                        
                        if(bonus_equiv != undefined && (bonus_equiv == "3xword" || bonus_equiv == "2xword")){
                            tmp_bonus[tmp_w[0]] = bonus_equiv;
                            if(bonus_equiv == "3xword")
                                word_bonus['h'] += tmp_w[1] * 2;
                            else if(bonus_equiv == "2xword")
                                word_bonus['v'] += tmp_w[1] * 1;
                        }

                        if(evw[tmp_w[0]] == undefined){
                            w_arr['vw'].push(tmp_w[0]);
                            evw[tmp_w[0]] = 1;
                            room_data[player_turn]['temp_sco'] += tmp_w[1];
                        }
                    }
                }

                //console.log(word_bonus['h'], word_bonus['v'], letter_bonus);
                room_data[player_turn]['temp_sco'] += word_bonus['h']+word_bonus['v']+letter_bonus;
                //console.log(room_data[player_turn]['temp_sco']);
                
                let tmp_arr = [];
                if(w_arr['hw'].length != 0){
                    for(let i=0; i<w_arr['hw'].length; i++)
                        tmp_arr.push(w_arr['hw'][i]);
                }
                if(w_arr['vw'].length != 0){
                    for(let i=0; i<w_arr['vw'].length; i++)
                        tmp_arr.push(w_arr['vw'][i]);
                }
                
                //test_word_list(tmp_arr, "msg");
                if(room_data['word_count'] == 0 && room_data['board'][112] == ""){
                    show_message("Cover the star of your first word.")
                }
                else if(room_data['word_count'] == 0 && tmp_arr.length == 0){
                    show_message("Atleast two letters to compose a word at the start.")
                }
                else if(tmp_arr.length != 0){
                    //console.log(room_data[player_turn]['temp_sco']);
                    socket.emit("word_checker", tmp_arr);
                }
                /*else if(room_data['word_count'] == 0 && h_str.length <= 1 && v_str.length <= 1){
                    show_message("Atleast two letters to compose a word at the start.")
                }
                else if(tmp_arr.length != 0){
                    socket.emit("word_checker", tmp_arr);
                }*/
            }
        }

        function set_player_rack(){
            let str = "";
            for(let i=0; i<room_data[ind_arr[1]]['rack'].length; i++){
                let ind = room_data[ind_arr[1]]['rack'][i];
                
                str += "<img letter='"+ind[0]+"' t_ind='"+ind+"' r_ind='"+i+"' class='tile_piece' draggable='true' ondragstart='dragstartHandler(event)' src='"+img_dir+"/tiles/"+ind+".png'>";
            }

            $("#player_rack").html(str);
        }

        function sort_array(arr, order){
            let i;
            let tmp;
            for(let i=0; i<arr.length-1; i++){
                for(let j=i+1; j<arr.length; j++){
                    let ind_a = parseInt(arr[i]);
                    let ind_b = parseInt(arr[j]);
                    if(order == "asc"){
                        if(ind_a>ind_b){
                            tmp = arr[i];
                            arr[i] = arr[j];
                            arr[j] = tmp;
                        }
                    }
                    else{
                        if(ind_a<ind_b){
                            tmp = arr[i];
                            arr[i] = arr[j];
                            arr[j] = tmp;
                        }
                    }
                }
            }
        }

        function draw_pouch_bag(ind){ 
            if(room_data['pouch_bag'].length > 6){
                let tiles_ctr = room_data[ind]['rack'].length;
                while(tiles_ctr < 7){
                    let rnd = get_random_num(room_data['pouch_bag'].length);
                    room_data[ind]['rack'][tiles_ctr] = room_data['pouch_bag'][rnd-1];
                    tiles_ctr++;
                    room_data['pouch_bag'].splice(rnd-1, 1);
                    if(room_data['pouch_bag'].length == 0)
                        break;
                }
            }
        }


        let target_st = "";
        let target_stb = "";
        function change_leter(){
            room_data[target_st] = $("#st_letter_inp").val();
            room_data['board'][target_stb] = target_st;
            $("#modalSetLetter").addClass('fade d-none');
            socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
        }

        function show_change_leter(cnd){
            if(cnd == undefined){
                retract_tiles(target_stb);
                $("#modalSetLetter").addClass('fade d-none');
                socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
            }
            else{
                target_stb = cnd;
                $("#modalSetLetter").removeClass('fade d-none');
            }
        }

        function set_next_turn(){
            for(i=0; i<active_players.length; i++){
                if(room_data['turn'] == active_players[i]){
                    room_data['turn'] = active_players[i+1];
                    break;
                }
            }
                
            if(room_data['turn'] == undefined){
                room_data['turn'] = 1;
            }
        }

        function retract_tiles(ind){
            if(ind != undefined){
                room_data[player_turn]['rack'].push(room_data['board'][ind]);
                room_data['board'][ind] = "";
                room_data['temp'].splice(room_data['temp'].length-1, 1);
            }
            else{
                for(let i=0; i<room_data['temp'].length; i++){
                    room_data[player_turn]['rack'].push(room_data['board'][room_data['temp'][i]]);
                    room_data['board'][room_data['temp'][i]] = "";
                }
            }
            set_player_rack();
        }

        function reset_std_start(){
            room_data[player_turn]['temp_sco'] = 0;
            room_data['mod'] = "";
            room_data['temp'] = [];
        }

        function set_board_position(target){
            
            let target_y = parseInt((target.split("_"))[0]);
            let target_x = parseInt((target.split("_"))[1]);

            let scroll_y;
            if(target_y < 5)
                scroll_y = 0;
            else if(target_y > 10)
                scroll_y = 7*60;
            else
                scroll_y = 3*60;

            let scroll_x;
            if(target_x < 5)
                scroll_x = 0;
            else if(target_x > 10)
                scroll_x = 7*60;
            else
                scroll_x = 3*60;

            $("#game_board_holder").animate({
                scrollTop: scroll_y, scrollLeft: scroll_x
            });
            /*$("#game_board_holder").animate({
                scrollTop: target*60
            });*/
        }

        function skip_turn(msg){
            if(on_redraw){
                for(let i=0; i<temp_draw_tiles.length; i++){
                    room_data[player_turn]['rack'].push(temp_draw_tiles[i]);
                }
                temp_draw_tiles = []
                set_player_rack();
                button_controls("ongame");
                $("#pouch_bag").html(room_data['pouch_bag'].length+temp_draw_tiles.length);
            }
            else{
                set_next_turn();

                if(msg != undefined)
                    room_data['result_msg'] = msg;

                retract_tiles();
                reset_std_start()
                room_data[player_turn]['skip']++; 

                if(check_end_game())
                    room_data['status'] = "end";
                else
                    room_data['result_msg'] = room_data[ind_arr[1]]['name']+"'s pass a turn";

                socket.emit("command", ["set", "update", ind_arr[0], "", "*", room_data]);
            }
        }

        function check_end_game(){
            let force_end = false;
            let skip_cnt = 0;
            for(i=0; i<active_players.length; i++){
                if(room_data[active_players[i]]['rack'].length == 0){
                    force_end = true;
                    break;
                } 
                else if(room_data[active_players[i]]['skip'] >= 2){
                    skip_cnt++;
                }
            }

            if(skip_cnt == active_players.length){
                room_data['result_msg'] = "All players committed 2 consecutive pass";
                force_end = true;
            }
            
            return force_end;
        }

        function check_winner(){
            let game_result = {}
            game_result['winner'] = "";
            game_result['high_score'] = [];
            game_result['sum_points'] = 0;

            for(i=0; i<active_players.length; i++){
                let ind = active_players[i];
                game_result[ind] = {}
                game_result[ind]['minus'] = 0;
                game_result[ind]['name'] = room_data[ind]['name'];
                game_result[ind]['score'] = room_data[ind]['score'];
                game_result[ind]['g_score'] = room_data[ind]['score'];
                game_result[ind]['rem_tile'] = room_data[ind]['rack'].length;
                for(j=0; j<room_data[ind]['rack'].length; j++){
                    game_result[ind]['minus'] += tile_sets_scores[room_data[ind]['rack'][j]];
                }

                game_result['sum_points'] += game_result[ind]['minus'];
                game_result[ind]['score'] -= game_result[ind]['minus'];

                if(game_result[ind]['rem_tile'] == 0){
                    game_result['winner'] = ind;
                }
                else{
                    if(game_result['high_score'].length == 0)
                        game_result['high_score'] = [ind, game_result[ind]['score']];
                    else
                        if(game_result['high_score'][1] < game_result[ind]['score'])
                            game_result['high_score'] = [ind, game_result[ind]['score']];
                }
            }
            
            if(game_result['winner'] == ""){
                game_result['winner'] = game_result['high_score'][0];
                game_result['sum_points'] = 0;
            }
            else{
                game_result[game_result['winner']]['score'] += game_result['sum_points'];
            }
            //console.log(game_result[game_result['winner']]);

            let str = "";
            let std_str = "<div class='w-100 p-2 d-flex justify-content-between'>";
            str += "<p><h3>"+game_result[game_result['winner']]['name']+"</h3></p>";
            str += std_str+"<span>Gross points</span> <span>"+game_result[game_result['winner']]['g_score']+"</span></div>";
            str += std_str+"<span>Minus points</span> <span>- "+game_result[game_result['winner']]['minus']+"</span></div>";
            str += std_str+"<span>Plus points</span> <span>+ "+game_result['sum_points']+"</p></div>";
            str += "<hr>";
            str += std_str+"<span>Total points</span> <span>"+game_result[game_result['winner']]['score']+"</span></div>";

            $("#dsp_game_result").html(str);
            $("#modalGameResult").removeClass('fade d-none');
        }

        function submit_compose(){
            room_data[player_turn]['score'] += room_data[player_turn]['temp_sco'];

            if(room_data['temp'].length == 7)
                room_data[player_turn]['score'] += 50;

            if(room_data['pouch_bag'].length > 6)
                draw_pouch_bag(room_data['turn']);
            
            set_next_turn();
            reset_std_start();
            room_data[player_turn]['skip'] = 0;

            if(check_end_game())
                room_data['status'] = "end";

            socket.emit("command", ["set", "update", ind_arr[0], "", "*", room_data]);
        }

        function cancel_compose(){
            if(room_data['temp'].length != 0){
                for(let i=0; i<room_data['temp'].length; i++){
                    room_data[player_turn]['rack'].push(room_data['board'][room_data['temp'][i]]);
                }

                for(let j=0; j<225; j++){
                    for(let k=0; k<room_data['temp'].length; k++){
                        if(room_data['temp'][k] == j){
                            room_data['board'][j] = "";
                        }
                    }
                }

                room_data['result_msg'] = room_data[player_turn]['name'] + " retracted move";
                reset_std_start()
                set_player_rack();
                socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
            }
        }

        function dragstartHandler(ev) {
            ev.dataTransfer.setData("tile_ind", $(ev.target).attr("t_ind"));
            ev.dataTransfer.setData("rack_ind", $(ev.target).attr("r_ind"));
        }

        function dragoverHandler(ev) {
            ev.preventDefault();
        }

        function check_near_by_cell(val){
            let response = false;
            if(room_data['board'][val] != "" && room_data['board'][val] != undefined)
                response = true;
            
            return response;
        }

        function check_solo_tile(ind){
            let response = false;
            if(check_near_by_cell(ind-1) || check_near_by_cell(ind+1) || check_near_by_cell(ind-15) || check_near_by_cell(ind+15)){
                response = true;
            }
            
            return response;
        }

        function check_drop_pos(obj){
            let response = false;
            let ind = parseInt($(obj).attr("tile_index"));
            let temp_ind = (dimen['blk'][ind]).split("_"); 
            
            if(room_data['word_count'] == 0){
                if(parseInt(temp_ind[0]) == 8 || parseInt(temp_ind[1]) == 8){
                    if(room_data['mod'] != 0){
                        let temp_a = (dimen['blk'][ind]).split("_"); 
                        let temp_b = (dimen['blk'][room_data['temp'][0]]).split("_"); 
                        
                        if(room_data['mod'] == 15 && (check_near_by_cell(ind-15) || check_near_by_cell(ind+15))){
                            if(temp_a[1] == temp_b[1])
                                response = true;
                        }
                        else if(room_data['mod'] == 1 && (check_near_by_cell(ind-1) || check_near_by_cell(ind+1))){
                            if(temp_a[0] == temp_b[0])
                                response = true;
                        }
                    }
                    else if(room_data['temp'].length != 0){
                        let temp_a = (dimen['blk'][ind]).split("_"); 
                        let temp_b = (dimen['blk'][room_data['temp'][0]]).split("_"); 
                        if(temp_a[0] == temp_b[0]){
                            room_data['mod'] = 1;
                            response = true;
                        }
                        else if(temp_a[1] == temp_b[1]){
                            room_data['mod'] = 15;
                            response = true;
                        }                     
                    }
                    else{
                        response = true;
                    }
                }
                else
                    show_message("You must start at the middle cross section of the board and cover the star with you first word.");
            }
            else{

                if(room_data['temp'].length == 0){
                    response = check_solo_tile(ind);// Set an invalid move during submition
                }
                else if(room_data['temp'].length == 1){
                    response = check_solo_tile(ind);// Set an invalid move during submition
                    let temp_a = (dimen['blk'][ind]).split("_"); 
                    let temp_b = (dimen['blk'][room_data['temp'][0]]).split("_"); 
                    if(temp_a[0] == temp_b[0]){
                        room_data['mod'] = 1;
                    }
                    else if(temp_a[1] == temp_b[1]){
                        room_data['mod'] = 15;
                    }    
                    else{
                        response = false;
                    }
                }
                else {
                    if(check_solo_tile(ind) == false)
                        return false;

                    let temp_a = (dimen['blk'][ind]).split("_"); 
                    let temp_b = (dimen['blk'][room_data['temp'][0]]).split("_"); 
                    if(room_data['mod'] == 1){
                        if(temp_a[0] == temp_b[0]){
                            response = true;
                        }
                    }
                    else if(room_data['mod'] == 15){
                        if(temp_a[1] == temp_b[1]){
                            response = true;
                        }  
                    }  
                    
                }
                /*if(room_data['mod'] == 0){
                    let ro, co, nr, nc;
                    
                    if(
                        ((check_near_by_cell(ind-1) && check_near_by_cell(ind-15)) || 
                        (check_near_by_cell(ind+1) && check_near_by_cell(ind+15)) || 
                        (check_near_by_cell(ind-1) && check_near_by_cell(ind+15)) || 
                        (check_near_by_cell(ind+1) && check_near_by_cell(ind-15))) &&
                        room_data['temp'].length == 0
                    ){
                        response = true;
                    }
                    else if(room_data['temp'].length != 0){
                        ro = ((dimen['blk'][room_data['temp'][0]]).split("_"))[0];
                        co = ((dimen['blk'][room_data['temp'][0]]).split("_"))[1];
                        nr = ((dimen['blk'][ind]).split("_"))[0];
                        nc = ((dimen['blk'][ind]).split("_"))[1];
                        if(co == nc){
                            room_data['mod'] = 15;
                            response = true;
                        }
                        else if(ro == nr){
                            room_data['mod'] = 1;
                            response = true;
                        }
                    }
                    else {
                        response = true;
                    }

                    response = check_solo_tile(ind);// Set an invalid move during submition
                }
                else{
                    let temp_b = (dimen['blk'][room_data['temp'][0]]).split("_"); 
                    if(room_data['mod'] == 1){
                        if(temp_ind[0] == temp_b[0])
                            response = true;
                    }
                    else if(room_data['mod'] == 15){
                        if(temp_ind[1] == temp_b[1])
                            response = true;
                    }
                }*/
                
                
            }                
            
            return response;
        }

        let on_redraw = false;
        let temp_draw_tiles = []
        function button_controls(cnd){
            if(cnd == "ondraw"){
                on_redraw = true;
                $("#btn_draw").removeClass("d-none");
                $("#btn_cancel").attr("disabled", true);
                $("#btn_submit").attr("disabled", true);
                $("#btn_skip").html("CANCEL");
            }
            else if(cnd == "ongame"){
                on_redraw = false;
                $("#btn_draw").addClass("d-none");
                $("#btn_cancel").attr("disabled", false);
                $("#btn_submit").attr("disabled", false);
                $("#btn_skip").html("PASS");
            }
        }
        button_controls("ongame");

        function pouch_player_redraw() {
            draw_pouch_bag(player_turn);
            set_player_rack();
            button_controls("ongame");
            for(let i=0; i<temp_draw_tiles.length; i++){
                room_data['pouch_bag'].push(temp_draw_tiles[i]);
            }
            temp_draw_tiles = []
            $("#pouch_bag").html(room_data['pouch_bag'].length+temp_draw_tiles.length);
            skip_turn(room_data[player_turn]['name']+"'s exchange tiles from the pouch");
        }

        function pouch_dragoverHandler(ev) {
            ev.preventDefault();
        }

        function pouch_dropHandler(ev) {
            ev.preventDefault();
            if(player_turn == ind_arr[1]){
                if(room_data['pouch_bag'].length > 7){
                    const tile_ind = ev.dataTransfer.getData("tile_ind");
                    const rack_ind = ev.dataTransfer.getData("rack_ind");

                    room_data[player_turn]['rack'].splice(parseInt(rack_ind),1);
                    //room_data['pouch_bag'].push(tile_ind);
                    temp_draw_tiles.push(tile_ind);
                    set_player_rack();
                    $("#pouch_bag").html(room_data['pouch_bag'].length+temp_draw_tiles.length);
                    button_controls("ondraw");
                }
                else{
                    console.log("Pouch tile is low");
                }
            }
        }

        function dropHandler(ev) {
            ev.preventDefault();
            if(player_turn == ind_arr[1]){
            const tile_ind = ev.dataTransfer.getData("tile_ind");
            const rack_ind = ev.dataTransfer.getData("rack_ind");
            
            if(tile_ind != "" && tile_ind != undefined && rack_ind != "" && rack_ind != undefined && check_drop_pos(ev.target)){

                let ind = parseInt($(ev.target).attr("tile_index"));

                if(room_data['board'][ind] == ''){
                    target_st = tile_ind;
                    room_data['result_msg'] = room_data[player_turn]['name'] +" composing...";
                    room_data['board'][ind] = tile_ind;
                    room_data['temp'].push(ind);

                    if(tile_ind == "_1" || tile_ind == "_2")
                        show_change_leter(ind);
                        
                    room_data[player_turn]['rack'].splice(parseInt(rack_ind),1);
                    //$(ev.target).html("<img class='tile_board' draggable='false' src='"+img_dir+"/tiles/"+tile_ind+".png'>");
                    set_player_rack();
                    socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
                }
            }
            }
        }

        socket.on('word_checker_return', function(data) {
            let invalid_str = "";
            let valid_str = "";
            let temp_strg = []
            let tmp_dup = {}
            
            for(let i=0; i<data[0].length; i++){
                let w_sep = "";
                let tmp_str = "";
                if(i<data[0].length-1){
                    w_sep = " │ ";
                }
                
                if(data[0][i] == ""){
                    tmp_str = "failed-hl";
                    invalid_str += "<span class='"+tmp_str+"'>"+data[1][i].toUpperCase()+"</span>"+w_sep;
                }
                else{
                    tmp_str = "success-hl";
                    valid_str += "<span class='"+tmp_str+"'>"+data[1][i].toUpperCase()+"</span>"+w_sep;
                }

                if(tmp_dup[data[1][i]] == undefined){
                    tmp_dup[data[1][i]] = 1;
                    temp_strg.push("<span class='"+tmp_str+"'>"+data[1][i].toUpperCase()+"</span>"); 
                }
                
            }
            
            if(valid_str != "" && invalid_str == ""){
                room_data['result_msg'] = room_data[player_turn]['name'] + " move accepted with <span class='success-hl'>+"+room_data[player_turn]['temp_sco']+"</span> points<br/><br/>"+"Valid word(s):<br/>" + valid_str;
                room_data['word_count'] = data[0].length;
                //test_word_list(valid_str, "con");
                submit_compose();
            }
            else if(valid_str == "" && invalid_str != ""){
                room_data['result_msg'] = room_data[player_turn]['name'] + " made an invalid move<br/><br/>"+"Invalid word(s):<br/>" + invalid_str;
                socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
            }
            else{
                let tmp_str = "";
                for(i=0; i<temp_strg.length; i++){
                    w_sep = "";
                    if(i<temp_strg.length-1){
                        w_sep = " │ ";
                    }
                    tmp_str += temp_strg[i]+w_sep;
                }
                room_data['result_msg'] = room_data[player_turn]['name'] + " made a mix valid and invalid move<br/>" + "<br/>Composed word(s):<br/>" + tmp_str;
                socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
            }
        });
            
        socket.on('player_data', function(server_data) {
            if(server_data[1] == "start"){
                room_data['status'] = "begin";
                room_data['winner'] = 0;
                room_data['turn'] = server_data[2];
                room_data['_1'] = "";
                room_data['_2'] = "";
                room_data['pouch_bag'] = []
                room_data['temp'] = []
                room_data['mod'] = 0;
                room_data['word_count'] = 0;
                room_data['result_msg'] = room_data[room_data['turn']]['name'] + " will start the game";

                for(i=0; i<Object.keys(std_tile_piece).length; i++){
                    let tmp_ind = Object.keys(std_tile_piece)[i];
                    for(j=0; j<std_tile_piece[tmp_ind]; j++){
                        room_data['pouch_bag'].push(tmp_ind);
                        /*tile_sets_scores[tmp_ind] = parseInt(tmp_ind.substring(1, tmp_ind.length));
                        if(tmp_ind.substring(0, 1) == "_")
                            tile_sets_scores[tmp_ind] = 0;
                        tile_sets_letters[tmp_ind] = tmp_ind.substring(0, 1);*/
                    }
                    /*if(room_data['pouch_bag'].length>22)
                        break;*/
                }

                for(i=0; i<active_players.length; i++){
                    room_data[active_players[i]]['score'] = 0;
                    room_data[active_players[i]]['temp_sco'] = 0;
                    room_data[active_players[i]]['rack'] = [];
                    room_data[active_players[i]]['skip'] = 0;
                    draw_pouch_bag(active_players[i]);
                }

                $("#dsp_game_result").html("");
                $("#modalGameResult").addClass('fade d-none');
                $(".board-cell").html("");
                show_message("");

                for(let j=0; j<225; j++){  
                    room_data['board'][j] = "";
                }
                
                
                socket.emit("command", ["set", "update", ind_arr[0], "", "*", room_data]);
            }
            else{
                data = server_data[0];

                for(i=0; i<data['board'].length; i++){
                    if(data['board'][i] != ''){
                        let hl = "";
                        let sp="";
                        if(data['board'][i] == undefined)
                            console.log(i);

                        if(data['board'][i] == "_1" || data['board'][i] == "_2")
                            sp = "<label class='sp-tile'>"+data[data['board'][i]].toUpperCase()+"</label>";

                        $("#cell_"+i).html(sp+"<img class='"+hl+" tile_board' draggable='false' src='"+img_dir+"/tiles/"+data['board'][i]+".png'>");
                    }
                    else{
                        $("#cell_"+i).html("");
                    }
                }

                if(player_turn != ind_arr[1])
                    set_board_position(dimen['blk'][data['temp'][data['temp'].length-1]]);

                show_message(data['result_msg']);
            }
        }); 

        socket.on('room_data', function(server_data) {
            let str = "";
            active_players = []
            let data = server_data[0];
            let room_event = server_data[1];
            let p_ind = server_data[2];
            if(data == "room-error"){
                alert("Room error problem occured. [Room doesn't exist]");
            }
            else{
                let obj = Object.keys(data);
                $("#game").removeClass("d-none");
                $("#room_id_dsp").html(data['id']);
                $("#player_rack").css("visibility", "hidden");
                $("#btn_play").css("visibility", "hidden");
                $("#btn_controls").css("visibility", "hidden")
                $("#turn_controls").css("visibility", "hidden")

                if(data['status'] == "" && data['players'] >= data['min_players']){
                    $("#btn_play").css("visibility", "visible");
                }

                if(data['status'] != ""){
                    $("#player_rack").css("visibility", "visible");
                }

                room_data = data;
                if(room_event == "suspend" || room_event == "resume"){
                    if(room_event == "resume"){
                        $("#p"+p_ind+"_status").html("Points: "+data[i]['score']);
                    }
                    else{
                        $("#p"+p_ind+"_status").html("offline");
                    }
                }
                else{
                    for(i=1; i<=obj.length; i++){
                        try{
                            
                            if(data[i]['status'] != "active"){
                                $("#p"+i+"_img").attr("src", img_dir+data[i]['char']+".png");
                                $("#p"+i+"_name").html(data[i]['name']);
                                $("#p"+i+"_status").html("offline");
                                if(data['status'] == 'begin'){
                                    $("#p"+i+"_ava").addClass("d-none");
                                }
                                else{
                                    $("#p"+i+"_ava").removeClass("d-none");
                                }
                            }
                            else{
                                active_players.push(data[i]['pid']);
                                $("#p"+i+"_name").html(data[i]['name']);
                                $("#p"+i+"_img").attr('src', img_dir+"ava-"+data[i]['pid']+".png");
                                $("#p"+i+"_status").html("Points: "+data[i]['score']);

                                if(data['status'] == 'begin'){
                                    if(data['winner'] == ""){
                                        if(data['turn'] == data[i]['pid']){
                                            $("#p"+i+"_indc").addClass("blinker");
                                        }
                                        else{
                                            $("#p"+i+"_indc").removeClass("blinker");
                                        }
                                    }
                                }
                            }
                        }
                        catch(e){
                            if(data['status'] == "begin")
                                $("#player"+i).addClass("d-none");
                        }
                    }

                    for(i=0; i<data['board'].length; i++){
                        if(data['board'][i] != ''){
                            let sp = "";
                            if(data['board'][i] == "_1" || data['board'][i] == "_2")
                                sp = "<label class='sp-tile'>"+data[data['board'][i]].toUpperCase()+"</label>";
                            $("#cell_"+i).html(sp+"<img class='tile_board' draggable='false' src='"+img_dir+"/tiles/"+data['board'][i]+".png'>");
                        }
                        else
                            $("#cell_"+i).html("");
                    }
                    
                    /*if(data['temp'].length == 0){
                        $(".tile_board").removeClass('hl-tiles');
                    }*/
                    
                    if(parseInt(ind_arr[1]) == data['turn']){
                        player_turn = data['turn'];
                        //$("#act_ind").html("DRAW");
                    }
                    else{
                        player_turn = 0;
                        //$("#act_ind").html("&nbsp;");
                    }
                    
                    /*if(data['status'] != "begin" && data['players'] >= data['min_players']){
                        $("#btn_play").css("visibility", "visible");
                        $("#player_rack").css("visibility", "hidden");
                    }
                    else{
                        $("#btn_play").css("visibility", "hidden");
                        $("#player_rack").css("visibility", "visible");
                    }*/

                    if(data['result_msg'] != "")
                        show_message(data['result_msg']);
                }

                if(data['status'] == "begin"){
                    if(player_turn != ind_arr[1]){
                        $("#btn_controls").css("visibility", "hidden")
                        $("#turn_controls").css("visibility", "hidden")
                    }
                    else{
                        $("#btn_controls").css("visibility", "visible")
                        $("#turn_controls").css("visibility", "visible")
                    }
                    
                    set_player_rack();
                    $("#pouch_bag").html(room_data['pouch_bag'].length); 
                }
                
                if(data['status'] == "end"){
                    check_winner();
                }
                
            }
        });

        function init_game(stat){
            $("#game_portal").addClass("d-none");
            $("#game").addClass("d-none");

            if(stat == "portal"){
                $("#game_portal").removeClass("d-none");
            }
            else if(stat == "game"){
                socket.emit("command", ["get", "update", ind_arr[0], parseInt(ind_arr[1]), "*"]);
                $("#game").removeClass("d-none");
                set_board();
            }
        }

        window.onload = function(){
            if(player_name == null){
                $("body").css("textAlign", "center");
                $("body").css("paddingTop", "20px");
                $("body").html("Invalid access!");
            }
            else{
                ind_arr = get_session("session");
                if(ind_arr.length == 0){
                    socket.emit("room_list", game_id);
                    init_game('portal');
                }
                else{
                    socket.emit("rejoin_room", ["set", "resume", ind_arr[0], parseInt(ind_arr[1])], "*");
                    init_game('game');
                }    
            }       
        }

        window.onbeforeunload = function(){
            if(ind_arr.length != 0){
                socket.emit("command", ["set", "suspend", ind_arr[0], parseInt(ind_arr[1]), "*"]);
            }
            
            /*if(ind_arr.length != 0){
                event.preventDefault();
                event.returnValue = ''; 
                socket.emit("command", ["set", "suspend", ind_arr[0], parseInt(ind_arr[1]), "*"]);
            }*/
        }

        function test_word_list(val, type){
            if(type == "msg"){
                let str = "";
                for(let i=0; i<val.length; i++){
                    str += val[i]+", ";

                }
                show_message(str);
            }
            else if(type == "trace"){
                show_message(val);
            }
            else{
                console.log(val);
            }
        }

	</script>
</html>