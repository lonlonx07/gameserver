<html>
    <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="../assets/css/mystyle.css" rel="stylesheet">
    <link href="../assets/css/snakes-and-ladders.css" rel="stylesheet">
    <title>SNAKES AND LADDERS</title>
	<style>
        
	</style>
	<body>
        <div class="container-fluid">	
            <div id="game_portal" class="row align-center h-100 d-none">
                <div class="menu col-md-6 text-center">
                    <div class="row">
                        <div class="col-md-12 mb-5 text-center">
                            <div class="mb-5 fs-2">CREATE NEW ROOM</div>
                            <span><button id="btn_create" class="strict-interact btn btn-primary">CREATE</button></span>
                        </div> 
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-12 mt-5 text-center">
                            <div class="mb-5 fs-2">JOIN EXISTING ROOM</div>
                            <strong>ENTER ROOM ID</strong>
                            <br/>
                            <input id="room_id" class="strict-interact inp" placeholder="enter room id">
                            <br/><br/>
                            <button id="btn_join" class="strict-interact btn btn-primary">JOIN</button>
                       </div>
                    </div>
                </div>
                
                <div class="col-md-6 h-100 " style="border-left-style: groove;border-left: solid 1px ;border-color:gray;">
                    <h3><strong>ROOM LIST</strong></h3>
                    <div id="room_list" style="max-height:90%; overflow:auto;"></div>
                </div>
            </div>

            <div id="game" class="d-none">
                <div class="row bg-primary">
                    <div class="p-2 d-flex justify-content-between">
                        <div class="col text-white fs-5 fw-bold">
                            SNAKES AND LADDERS
                        </div>
                        <div id="room_controls">
                            <span class="badge d-flex fs-6 align-items-center text-bg-primary rounded-pill">
                                <strong>ROOM ID:</strong>&ensp;<span id="room_id_dsp" class="" >???</span>
                                <i id="btn_copy" class="btn btn-primary fa-solid fa-copy" onclick="copy_room_id()" title="copy"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row p-2">
                        <div class="col-2">
                            <div id="player1" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p1_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p1_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p1_status"></small>
                                        <!--a id="p1_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p1_indc"></div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div id="player3" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p3_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p3_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p3_status"></small>
                                        <!--a id="p3_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p3_indc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-8 text-center">
                            <div class="row h-80">
                                <div class="col-12 p-3">
                                    <div id="game_board"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-2">
                            <div id="player2" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p2_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p2_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p2_status"></small>
                                        <!--a id="p2_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p2_indc"></div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <div id="player4" class="card shadow-sm">
                                <div class="card-body">
                                    <div class="text-center">
                                        <img class="player-ava" id="p4_img" src="../images/snakes-and-ladders/unknown.png">
                                        <div><span id="p4_name" class="card-text player-name">???</span></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <small id="p4_status"></small>
                                        <!--a id="p4_pass_turn" class="btn btn-sm btn-outline-secondary d-none" onclick="">PASS</a-->
                                        </div>
                                        <div class="indc" id="p4_indc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>  

                <div class="row">
                    <div class="col-12">  
                        <div id="game_controls" class="fixed-bottom mt-1 w-100" style="margin-bottom: -20;">
                            <table class="table table-bordered">
                                <tr>
                                    <td style="width:170px;background-color:black;text-align: center;">
                                        <img class="d-none" id="dice_anim" src="../images/snakes-and-ladders/dice-anim.gif" width="120px" height="120px">
                                        <img class="button-mode" id="dice_static" src="../images/snakes-and-ladders/dice_1.png" onclick="init_draw_dice()" width="120px" height="120px">
                                        <label id="act_ind">&nbsp;</label>
                                    </td>
                                    <td style="width: 500px;text-align: center;">
                                        <h2 id="char_msg">&nbsp;</h2>
                                        <button id="btn_play" class="btn btn-primary mt-2 d-none" onclick="start_game()">START</button>
                                    </td>
                                    <td  style="width:170px;background-color:black;text-align: center;">
                                        <label id="game_msg" style="color:white;font-weight:bold;"></label>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>  
        </div>                            
	</body>

	<script src="/socket.io/socket.io.js"></script>
    <script src="../assets/dist/js/jquery-3.6.3.js"></script>
    <script src="../assets/js/scripts.js"></script>
	<script>
        let img_dir = "../images/snakes-and-ladders/";
        let player_piece = "";
        let room_data = {};
        let player_turn = 0;
        let ind_arr;
        let game_id = "snakes-and-ladders";
        let room_index = [
            ["title","SNAKES AND LADDERS"], 
            ["game_id",game_id],
            ["id","room_id"], 
            ["max_players",4],
            ["min_players",2],
            ["t_limit",3600], 
            ["turn","int"],
            ["next_turn","int"],
            ["winner","int"],
            ["status", ""],
            ["dice_rnd",1],
            ["dice_rot",90],
            ["dice_stat","static"],
            ["ext_move","int"],
            ["moves","array"],
            ["target_char","int"],
            ["result_msg","string"]
        ];
        let player_index = [
            ["pid","player_ind"], 
            ["name",player_name], 
            ["status","active"], 
            ["char","string"],
            ["score","int"],
            ["block","int"]
        ];
        
        let draw_timer;
        let move_timer;
        let board_index = [10,9,8,7,6,5,4,3,2,1,
		11,12,13,14,15,16,17,18,19,20,
		30,29,28,27,26,25,24,23,22,21,
		31,32,33,34,35,36,37,38,39,40,
		50,49,48,47,46,45,44,43,42,41,
		51,52,53,54,55,56,57,58,59,60,
		70,69,68,67,66,65,64,63,62,61,
		71,72,73,74,75,76,77,78,79,80,
		90,89,88,87,86,85,84,83,82,81,
		91,92,93,94,95,96,97,98,99,100]
        let ladder = []
		ladder[1] = 38;
		ladder[4] = 14;
		ladder[9] = 31;
		ladder[21] = 42;
		ladder[28] = 84;
		ladder[51] = 67;
		ladder[72] = 91;
		ladder[80] = 99;
		let snake = []
		snake[17] = 7;
		snake[54] = 34;
		snake[62] = 19;
		snake[64] = 60;
		snake[87] = 36;
		snake[93] = 73;
		snake[95] = 75;
		snake[98] = 79;

        let active_players = []
        function start_game(){
            socket.emit("command", ["", "start", ind_arr[0], "", "*", ""]);
        }

        function display_winner(){
            $("#char_msg").html(room_data[room_data['winner']]['name'] + " Win!");
            $("#btn_play").html("Play Again");
            $("#btn_play").removeClass('d-none');
        }

        function dsp_dice_result(){
            let rnd = room_data['dice_rnd'];
            let rot = room_data['dice_stat'];
            $('#dice_static').css({
				'transform': 'rotate(' + rot + 'deg)',
				'-ms-transform': 'rotate(' + rot + 'deg)',
				'-moz-transform': 'rotate(' + rot + 'deg)',
				'-webkit-transform': 'rotate(' + rot + 'deg)',
				'-o-transform': 'rotate(' + rot + 'deg)'
			}); 
			$("#dice_static").attr('src', '../images/snakes-and-ladders/dice_'+rnd+'.png');
        }

        let move_ind_ctr=0;
        function move_char(){
            $(".board-cell").html("");
            let tmp_ava;
            for(i=0; i<active_players.length; i++){
                if(room_data['turn'] != active_players[i]){
                    if(room_data[active_players[i]]['block'] != room_data['moves'][move_ind_ctr]){
                        tmp_ava = img_dir+"ava-"+active_players[i]+".png";
                        $("#g_"+board_index[room_data[active_players[i]]['block']-1]).html("<img class='board-piece' src='"+tmp_ava+"'>");
                    }
                }
                else{
                    tmp_ava = img_dir+"ava-"+room_data['target_char']+".png";
                    $("#g_"+board_index[room_data['moves'][move_ind_ctr]-1]).html("<img class='board-piece' src='"+tmp_ava+"'>");
                }
            }
            
            
            let moves_len = room_data['moves'].length-1;
        
            if(move_ind_ctr == moves_len){
                clearInterval(move_timer);
                room_data[room_data['target_char']]['block'] = room_data['moves'][move_ind_ctr];
                if(room_data['moves'][move_ind_ctr] == 100){
                    //$("#char_msg").html(room_data[room_data['target_char']]['name'] + "Winner!")
                    room_data['winner'] = room_data['target_char'];
                    display_winner();
                    room_data['status'] = "end";
                }
                else{
                    $("#char_msg").html("");
                    $(".indc").removeClass("blinker");
                    $("#p"+room_data['next_turn']+"_indc").addClass("blinker");

                    if(parseInt(ind_arr[1]) == room_data['next_turn']){
                        player_turn = parseInt(ind_arr[1]);
                        $("#act_ind").html("TAP HERE");
                    }
                    else{
                        player_turn = 0;
                        $("#act_ind").html("&nbsp;");
                    }

                    room_data['turn'] = room_data['next_turn'];
                }

                room_data['dice_stat'] = "static";
                socket.emit("command", ["set", "target", ind_arr[0], "", "*", room_data]);
            }
            else{
                if(room_data['dice_rnd'] == moves_len && move_ind_ctr == moves_len-1){
                   if(ladder[room_data['moves'][moves_len-1]] != undefined){
                        $("#char_msg").html("Yeah!");
                    }
                    else if(snake[room_data['moves'][moves_len-1]] != undefined){
                        $("#char_msg").html("Oh no!");
                    }
                }
                
                move_ind_ctr++;
            }
        }

        function draw_stop(){
            $("#dice_static").removeClass('d-none');
            $("#dice_anim").addClass('d-none');
            $("#dice_static").removeClass('d-none');
            
            clearInterval(draw_timer);

            let moves_len = room_data['moves'].length-1;
            if(room_data['dice_rnd'] == moves_len)
                $("#char_msg").html("Proceed to block "+room_data['moves'][moves_len-1]);
            else
                $("#char_msg").html("Proceed to block "+room_data['moves'][moves_len]);

            dsp_dice_result();
            move_timer = setInterval(move_char, 1000);
        }

        let pd_roll = false;
        function init_draw_dice(){
            if(player_turn == parseInt(ind_arr[1]) && room_data['status'] == "begin"){
                pd_roll = true;
                let rnd = get_random_num(6);
                let rot = get_random_num(180);

                
                room_data['moves'] = [];
                room_data['target_char'] = parseInt(ind_arr[1]);
                let tmp_move_cnt = room_data[parseInt(ind_arr[1])]['block'];
                let add_n = 1;
                for(i=1; i<=rnd; i++){
                    tmp_move_cnt+=add_n;
                    room_data['moves'].push(tmp_move_cnt);
                    if(tmp_move_cnt == 100)
                        add_n = -1;
                }

                if(ladder[tmp_move_cnt] != undefined){
                    room_data['moves'].push(ladder[tmp_move_cnt]);
                }
                else if(snake[tmp_move_cnt] != undefined){
                    room_data['moves'].push(snake[tmp_move_cnt]);
                }

                /*room_data[parseInt(ind_arr[1])]['block'] += rnd;
                let tmp_ind = room_data[parseInt(ind_arr[1])]['block'];
                if(ladder[tmp_ind] != undefined){
                    room_data['ext_move'] = ladder[tmp_ind];
                }
                else if(snake[tmp_ind] != undefined){
                    room_data['ext_move'] = snake[tmp_ind];
                }

                if(room_data[parseInt(ind_arr[1])]['block'] > 100)
                    room_data[parseInt(ind_arr[1])]['block'] = 100 - (room_data[parseInt(ind_arr[1])]['block'] - 100);*/

                let tmp_next_turn;     
                for(i=0; i<active_players.length; i++){
                    if(active_players[i] == player_turn){
                        tmp_next_turn = active_players[i+1];   
                        break;
                    }
                }
                if(tmp_next_turn == undefined){
                    tmp_next_turn = 1;
                }
                room_data['next_turn'] = tmp_next_turn;

                room_data['dice_rnd'] = rnd;
                room_data['dice_rot'] = rot;
                room_data['dice_stat'] = "draw";
                socket.emit("command", ["set", "update", ind_arr[0], "", "*", room_data]);
            }
        }

        function on_draw_dice(){
            move_ind_ctr = 0;
            $("#dice_anim").removeClass('d-none');
            $("#dice_static").addClass('d-none');
            $("#act_ind").html("&nbsp;");

            draw_timer = setInterval(draw_stop, 1000);
        }

        function set_board(){
			let str = "";
			for(let g=1; g<=100; g++){
				str = "<div class='board-cell' id='g_"+g+"'></div>"+str;
			}
			
            $("#game_board").html(str);

			let posx = 0;
			let posy = 0;
            let board_w = 480;
            let board_h = 480;
            let cell_size = (board_w/10);
			for(let j=100; j>0; j--){
					$("#g_"+j).css('background-image', 'url("../images/snakes-and-ladders/board.png")');
					$("#g_"+j).css('background-size', board_w+"px "+board_h+"px");
					$("#g_"+j).css('background-repeat', 'no-repeat');

					
					$("#g_"+j).css('background-position-x', posx-1);
					$("#g_"+j).css('background-position-y', posy-1);
					if(board_w == Math.abs(posx)+cell_size){
						posy -= cell_size;
						posx = 0;
					}
					else{
						posx -= cell_size;
					}
			}

            $("#game_board div").css('width', cell_size+"px");
            $("#game_board div").css('height', cell_size+"px");
            $("#game_board").css('width', board_w+"px");
            $("#game_board").css('height', board_w+"px");
            $(".board-piece").css('objectFit', "fit");
            
            /*
            board_size = [450,450];
            cell_size = [45,45]

			for(let g=1; g<=100; g++){
				str = "<div class='board-cell' id='g_"+g+"'></div>"+str;
			}
			
            $("#game_board").html(str);

			let posx = 0;
			let posy = 0;
			for(let j=100; j>0; j--){
					$("#g_"+j).css('background-image', 'url("../images/snakes-and-ladders/board.png")');
					$("#g_"+j).css('background-size', cell_size[0]+"px"+cell_size[1]+"px");
					$("#g_"+j).css('background-repeat', 'no-repeat');

					
					$("#g_"+j).css('background-position-x', posx-1);
					$("#g_"+j).css('background-position-y', posy-1);
					if(board_size[0] == Math.abs(posx)+cell_size[0]){
						posy -= cell_size[0];
						posx = 0;
					}
					else{
						posx -= cell_size[0];
					}
			}

            $(".board-piece").css('width', cell_size[0]+"px");
            $(".board-piece").css('height', cell_size[1]+"px");
            $("#game_board div").css('width', cell_size[0]+"px");
            $("#game_board div").css('height', cell_size[1]+"px");
            //$(".board-cell").attr('style', "width:"+cell_size[0]+"px; height:"+cell_size[1]+"px;");
            $("#game_board").attr('style', "width:"+board_size[0]+"px; height:"+board_size[1]+"px;");
            */
			
		}

        socket.on('player_data', function(server_data) {
            if(server_data[1] == "start"){
                room_data['status'] = "begin";
                room_data['winner'] = 0;
                room_data['turn'] = parseInt(ind_arr[1]);
                for(i=0; i<active_players.length; i++){
                    room_data[active_players[i]]['block'] = 0;
                }

                $(".board-cell").html("");
                $("#game_msg").html("");
                $("#char_msg").html("");
                socket.emit("command", ["set", "update", ind_arr[0], "", "*", room_data]);
            }
            else{
                data = server_data[0];
                let obj = Object.keys(data);
                for(i=1; i<=obj.length; i++){
                    try{
                        if(data['dice_stat'] == "static"){
                            let tmp_ava = img_dir+"ava-"+i+".png";
                            if(data[i]['block'] == data[ind_arr[1]]['block'] && data[i]['pid'] != data[ind_arr[1]]['pid'])
                                tmp_ava = img_dir+"ava-"+ind_arr[1]+".png";
                            $("#g_"+board_index[data[i]['block']-1]).html("<img class='board-piece' src='"+tmp_ava+"'>");

                        }
                    }catch(e){}
                }
            }
        }); 

        socket.on('room_data', function(server_data) {
            let str = "";
            active_players = []
            let data = server_data[0];
            let room_event = server_data[1];
            let p_ind = server_data[2];
            if(data == "room-error"){
                alert("Room error problem occured. [Room doesn't exist]");
            }
            else{
                let obj = Object.keys(data);
                $("#game").removeClass("d-none");
                $("#room_id_dsp").html(data['id']);
                room_data = data;
                if(room_event == "suspend" || room_event == "resume"){
                    if(room_event == "resume"){
                        $("#p"+p_ind+"_status").html("");
                    }
                    else{
                        $("#p"+p_ind+"_status").html("offline");
                    }
                }
                else{
                    for(i=1; i<=obj.length; i++){
                        try{
                            if(data['dice_stat'] == "static"){
                                let tmp_ava = img_dir+"ava-"+i+".png";
                                if(data[i]['block'] == data[ind_arr[1]]['block'] && data[i]['pid'] != data[ind_arr[1]]['pid'])
                                    tmp_ava = img_dir+"ava-"+ind_arr[1]+".png";
                                $("#g_"+board_index[data[i]['block']-1]).html("<img class='board-piece' src='"+tmp_ava+"'>");

                            }

                            if(data[i]['block'] == 100)
                                display_winner(i);

                            
                            if(data[i]['status'] != "active"){
                                $("#p"+i+"_img").attr("src", img_dir+data[i]['char']+".png");
                                $("#p"+i+"_name").html(data[i]['name']);
                                $("#p"+i+"_status").html("offline");
                                if(data['status'] == 'begin'){
                                    $("#p"+i+"_ava").addClass("d-none");
                                }
                                else{
                                    $("#p"+i+"_ava").removeClass("d-none");
                                }
                            }
                            else{
                                active_players.push(data[i]['pid']);
                                $("#p"+i+"_name").html(data[i]['name']);
                                $("#p"+i+"_img").attr('src', img_dir+"ava-"+data[i]['pid']+".png");
                                $("#p"+i+"_status").html("");
                                //$("#p"+i+"_block").html(data[i]['block']);

                                if(data['status'] == 'begin'){
                                    if(data['winner'] == ""){
                                        if(data['turn'] == data[i]['pid']){
                                            $("#p"+i+"_indc").addClass("blinker");
                                        }
                                        else{
                                            $("#p"+i+"_indc").removeClass("blinker");
                                        }
                                    }
                                }
                            }
                        }
                        catch(e){
                            if(data['status'] == "begin")
                                $("#player"+i).addClass("d-none");
                        }
                    }
                    
                    
                    if(parseInt(ind_arr[1]) == data['turn']){
                        player_turn = data['turn'];
                        $("#act_ind").html("TAP HERE");
                    }
                    else{
                        player_turn = 0;
                        $("#act_ind").html("&nbsp;");
                    }
                    
                    if(data['status'] != "begin" && data['players'] >= data['min_players']){
                        $("#btn_play").removeClass('d-none');
                    }
                    else{
                        $("#btn_play").addClass('d-none');
                    }
                    
                    if(data['status'] == "begin" && data['dice_stat'] == "draw"){
                        on_draw_dice();
                    }
                    else{
                        dsp_dice_result();
                    }
                }
            }
        });

        function init_game(stat){
            $("#game_portal").addClass("d-none");
            $("#game").addClass("d-none");

            if(stat == "portal"){
                $("#game_portal").removeClass("d-none");
            }
            else if(stat == "game"){
                socket.emit("command", ["get", "update", ind_arr[0], parseInt(ind_arr[1]), "*"]);
                $("#game").removeClass("d-none");
                set_board();
            }
        }

        window.onload = function(){
            if(player_name == null){
                $("body").css("textAlign", "center");
                $("body").css("paddingTop", "20px");
                $("body").html("Invalid access!");
            }
            else{
                ind_arr = get_session("session");
                if(ind_arr.length == 0){
                    socket.emit("room_list", game_id);
                    init_game('portal');
                }
                else{
                    socket.emit("rejoin_room", ["set", "resume", ind_arr[0], parseInt(ind_arr[1])], "*");
                    init_game('game');
                }    
            }       
        }

        window.onbeforeunload = function(){
            if(ind_arr.length != 0){
                socket.emit("command", ["set", "suspend", ind_arr[0], parseInt(ind_arr[1]), "*"]);
            }
            
            /*if(ind_arr.length != 0){
                event.preventDefault();
                event.returnValue = ''; 
                socket.emit("command", ["set", "suspend", ind_arr[0], parseInt(ind_arr[1]), "*"]);
            }*/
        }

	</script>
</html>